# Primal Logic - Gift機能完全仕様

> 作成日: 2025-01-27
> 参考: 習慣化アプリ（If-Then Habit）のGift機能 v4

---

## 概要

### コンセプト
**コミュニティを通じた月額割引の変動体験**

課金の100%がギフト（新規ユーザーへの割引）に変換されることで、罪悪感なく気軽に課金でき、利他的な刺激にもなる。

### 基本仕組み
```
今月のGift総額 ÷ 今月の新規加入者 = 割引額(1人あたり)
```

**例:**
- Gift総額: 50,000円
- 新規加入者: 20人
- 割引額: 2,500円/人

---

## 核心的な特徴

### 1. 100%ギフト変換
- **課金の100%がギフトに変換される**
- 開発者への利益ではなく、全て新規ユーザーへの割引として使用
- これにより罪悪感なく気軽に課金できる
- 利他的な刺激にもなる

### 2. 毎月の値段計算式
- **毎月のGift総額を計算**
- **今月の新規加入者数を取得**
- **割引額 = Gift総額 ÷ 新規加入者数**
- 毎月変動する割引額により、コミュニティの貢献度が可視化される

### 3. 初月割引
- **初月に入った人のために安くする**
- 新規ユーザーは、その月のGift総額に応じた割引を受け取れる
- 割引額は毎月変動するため、コミュニティの貢献度が直接反映される

### 4. メッセージ機能
- **金払って初月の人へのメッセージを書ける**
- Gift購入時に、新規ユーザーへのメッセージを入力可能
- メッセージは新規ユーザーが割引を受け取る際に表示される
- コミュニティの温かみを伝える機能

### 5. Tips促進機能
- **Tipsをもっと見るようにする**
- Gift購入者には、Tipsをより多く表示するなどの特典を付与
- または、Tips表示を促進する機能を実装
- 学習意欲を高める仕組み

### 6. コスチューム機能（検討中）
- **コスチュームにするかどうかは未決定**
- 将来的に、Gift購入者にコスチューム（アバターやテーマなど）を付与する可能性
- 現時点では実装予定なし

---

## 実装フロー

### 1. 購入フロー（購入者）

```
━━━━━━━━━━━━━━━━
Gift
━━━━━━━━━━━━━━━━

新しい仲間を応援しよう

あなたのGiftが、
新規ユーザーの割引になります。

━━━━━━━━━━━━━━━━

今月の状況:
Gift総額: 50,000円
新規加入者: 20人
現在の割引: 2,500円/人

━━━━━━━━━━━━━━━━

メッセージを入力（任意）:
[新規ユーザーへのメッセージを入力...]

━━━━━━━━━━━━━━━━

Giftチケットを購入:
[¥3,980 で1ヶ月分を贈る]

※ 100%が新規ユーザーへの割引に変換されます

━━━━━━━━━━━━━━━━
```

### 2. 新規ユーザーへの割引適用

**タイミング:** 毎月1日 00:00（スケジュールトリガー）

**フロー:**
1. Supabase: 先月のGift総額を取得
2. Supabase: 先月の新規加入者数を取得
3. 計算: 割引額 = Gift総額 ÷ 新規加入者数
4. 新規ユーザーに割引を適用（StripeクーポンまたはRevenueCatプロモーショナル期間）
5. Supabase: 記録

### 3. メッセージ表示

新規ユーザーが割引を受け取る際に、Gift購入者からのメッセージを表示：

```
━━━━━━━━━━━━━━━━
🎁 Gift割引を受け取りました！

割引額: 2,500円

━━━━━━━━━━━━━━━━

コミュニティからのメッセージ:

「カーニボアダイエットを始めるあなたを応援しています！
一緒に健康な体を目指しましょう！」

━━━━━━━━━━━━━━━━
```

---

## データベース設計

### gifts テーブル

```sql
CREATE TABLE gifts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  amount INT NOT NULL,
  month TEXT NOT NULL, -- '2025-01'
  message TEXT, -- 新規ユーザーへのメッセージ（任意）
  payment_provider TEXT NOT NULL, -- 'stripe' | 'revenuecat'
  transaction_id TEXT, -- 決済トランザクションID
  created_at TIMESTAMP DEFAULT NOW()
);
```

### gift_calculations テーブル

```sql
CREATE TABLE gift_calculations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  month TEXT NOT NULL UNIQUE, -- '2025-01'
  total_amount INT NOT NULL, -- その月のGift総額
  new_user_count INT NOT NULL, -- その月の新規加入者数
  discount_per_user INT NOT NULL, -- 1人あたりの割引額
  created_at TIMESTAMP DEFAULT NOW()
);
```

### gift_messages テーブル（新規ユーザーへのメッセージ表示用）

```sql
CREATE TABLE gift_messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  gift_id UUID REFERENCES gifts(id) ON DELETE CASCADE,
  recipient_user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  message TEXT NOT NULL,
  displayed_at TIMESTAMP, -- メッセージが表示された日時
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 決済システム

### オプション1: Stripe（Web課金）

```yaml
方式: Stripe Checkout（Reader App方式）
- アプリ内に課金UIを直接出さず、Webに遷移してStripe Checkoutで決済
- 決済後はDeep Link等でアプリに戻る
- Gift購入は「消耗型アイテム」として扱う
```

### オプション2: RevenueCat（モバイル課金）

```yaml
方式: RevenueCat（消耗型アイテム + プロモーショナル・エンタイトルメント）
- App Store / Google Play課金に対応
- Gift機能は「消耗型アイテム」として実装
- 新規ユーザーへの割引は「プロモーショナル・エンタイトルメント」で付与
```

---

## UI/UX設計

### Gift購入画面

**配置場所:** 設定画面または専用のGift画面

**要素:**
1. **今月の状況表示**
   - Gift総額
   - 新規加入者数
   - 現在の割引額

2. **メッセージ入力欄（任意）**
   - 新規ユーザーへのメッセージを入力
   - 文字数制限: 200文字程度

3. **購入ボタン**
   - 「¥3,980 で1ヶ月分を贈る」
   - 「100%が新規ユーザーへの割引に変換されます」という説明を表示

4. **Tips促進機能の説明**
   - Gift購入者にはTipsをより多く表示するなどの特典があることを明記

### 新規ユーザーへの割引通知

**表示タイミング:** 新規登録時または初回ログイン時

**要素:**
1. 割引額の表示
2. コミュニティからのメッセージ（複数ある場合はランダム表示）
3. 「割引を受け取る」ボタン

---

## Gift ON/OFFトグル

### UI配置

```
━━━━━━━━━━━━━━━━
設定
━━━━━━━━━━━━━━━━

Gift機能        ◉ ON
                ○ OFF

━━━━━━━━━━━━━━━━
```

### ON/OFFの挙動

```yaml
ON(デフォルト):
- Gift購入ボタン表示
- 新規登録割引に貢献
- コミュニティ感の醸成

OFF:
- Gift購入ボタン非表示
- 割引は受け取れる(新規登録時)
- 既存ユーザーは寄付しない選択肢
```

---

## 余剰分の処理

### 計算後の余剰

Gift総額を新規ユーザー数で割った際に発生する端数・余剰は以下の通り処理する:

- **余剰分**: 慈善団体に寄付
- **寄付先選択**: 全ユーザーの投票で毎月決定（3候補から選択）
- **透明性**: 寄付額と寄付先を毎月公開
- **ブランディング**: 「Primal Logicユーザーからの寄付」としてPR

### 新規ユーザー0人の月

- Gift総額は翌月に繰り越し
- 繰り越しは最大3ヶ月まで
- 3ヶ月経過で寄付に回す

---

## 実装優先順位

### Phase 1: 基本機能
1. データベース設計（gifts, gift_calculations, gift_messagesテーブル）
2. Gift購入フロー（Stripe決済）
3. 割引計算ロジック（Edge Function）
4. 新規ユーザーへの割引適用

### Phase 2: メッセージ機能
5. メッセージ入力UI
6. メッセージ保存・表示機能
7. 新規ユーザーへのメッセージ表示

### Phase 3: Tips促進機能
8. Tips表示促進機能（Gift購入者への特典）
9. Tips表示頻度の調整

### Phase 4: 余剰分処理
10. 余剰分の計算
11. 投票機能（寄付先選択）
12. 寄付処理

### Phase 5: コスチューム機能（検討中）
13. コスチューム機能の実装（未決定）

---

## 注意事項

### 法的対応
- 課金の100%がギフトに変換されることを明示
- 寄付先の透明性を確保
- プライバシーポリシーにGift機能の説明を追加

### セキュリティ
- 決済情報の適切な管理
- メッセージの不適切な内容のフィルタリング
- スパム防止（同一ユーザーからの大量購入の制限）

---

## 参考資料

- 習慣化アプリ（If-Then Habit）のGift機能 v4: `second-brain/08_Gift機能_v4.md`
- Stripe決済: `primal-logic-app/primal-logic-web/README.md`
- RevenueCat決済（モバイル）: 将来的に実装予定

